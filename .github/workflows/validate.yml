name: Validate Setup Scripts

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run ShellCheck
        # FIX 1: Use a stable version (v2) instead of master to prevent download errors
        uses: ludeeus/action-shellcheck@v2
        with:
          scandir: "./scripts"
          severity: "warning"

  test-fedora:
    name: Dry Run on Fedora
    runs-on: ubuntu-latest
    container: fedora:41
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        # FIX 2: Add 'jq' so detect-hardware.sh works during dry-run
        run: |
          dnf install -y git which sudo util-linux jq

      - name: Create Test User
        run: |
          useradd testuser
          echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Run Bootstrap (Dry Run)
        run: |
          # Fix permissions so testuser can write logs
          chown -R testuser:testuser $GITHUB_WORKSPACE

          # Run the script as testuser
          su - testuser -c "cd $GITHUB_WORKSPACE && ./bootstrap-fedora.sh --dry-run"

      - name: Test Backup Script
        run: |
          su - testuser -c "cd $GITHUB_WORKSPACE && ./scripts/export-config.sh"
