name: Validate Setup Scripts

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # FIX: Install ShellCheck from stable Ubuntu repos to avoid curl/network errors
      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      # FIX: Run ShellCheck manually on all .sh files
      - name: Run ShellCheck
        run: find . -type f -name "*.sh" -exec shellcheck {} +

  test-fedora:
    name: Dry Run on Fedora
    runs-on: ubuntu-latest
    container: fedora:41
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          dnf install -y git which sudo util-linux jq

      - name: Create Test User
        run: |
          useradd testuser
          echo "testuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Run Bootstrap (Dry Run)
        run: |
          chown -R testuser:testuser $GITHUB_WORKSPACE
          su - testuser -c "cd $GITHUB_WORKSPACE && ./bootstrap-fedora.sh --dry-run"

      - name: Test Backup Script
        run: |
          su - testuser -c "cd $GITHUB_WORKSPACE && ./scripts/export-config.sh"
